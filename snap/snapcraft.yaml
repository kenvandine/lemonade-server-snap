name: lemonade-server
version: "9.1.4"
base: core24
summary: Local AI server with OpenAI-compatible API
title: Lemonade Server
description: |
  Lemonade Server is a lightweight, high-performance local AI inference server
  that provides an OpenAI-compatible API for running large language models on
  your own hardware.

  **Features:**
  - OpenAI-compatible REST API (chat completions, embeddings, etc.)
  - Multiple backend support: Vulkan, ROCm (AMD GPUs), and CPU
  - Automatic model management and caching
  - Support for GGUF models from Hugging Face
  - Low latency local inference
  - Runs as a background service

  **Supported Hardware:**
  - AMD GPUs: RDNA3 (RX 7000), RDNA4 (RX 9000), Strix Point/Halo APUs
  - Any Vulkan-capable GPU
  - CPU fallback for systems without GPU acceleration

  **Quick Start:**
  The server starts automatically after installation. Access the API at:
  http://localhost:8000/api/v1

  **ROCm Support (AMD GPUs):**
  For ROCm GPU acceleration, connect the process-control interface:
  sudo snap connect lemonade-server:process-control

  For status/metrics reporting, lemonade-server.metrics requires:
  sudo snap connect lemonade-server:system-observe

  **Documentation:** https://lemonade-server.ai/

adopt-info: lemonade-server
grade: stable
confinement: strict
license: Apache-2.0

website: https://lemonade-server.ai
source-code: https://github.com/lemonade-sdk/lemonade
issues: https://github.com/kenvandine/lemonade-server-snap/issues
contact: https://github.com/kenvandine/lemonade-server-snap/issues

platforms:
  amd64:

layout:
  /usr/share/lemonade-server:
    symlink: $SNAP/usr/share/lemonade-server
  /usr/share/hwdata:
    symlink: $SNAP/usr/share/hwdata
  /usr/share/misc/pci.ids:
    bind-file: $SNAP/usr/share/misc/pci.ids

slots:
  # Adds a pseudo content interface to allow clients to express their
  # runtime dependency on lemonade-server
  install-lemonade-runtime-dependency:
    interface: content
    content: foo
    read:
      - $SNAP/meta/snap.yaml

apps:
  metrics:
    command: bin/metrics
    plugs:
      - home
      - removable-media
      - network
      - network-bind
      - opengl
      - process-control
      - hardware-observe
      - system-observe
  lemonade-server:
    command: usr/bin/lemonade-server
    plugs:
      - home
      - removable-media
      - network
      - network-bind
      - opengl
      - hardware-observe
      - system-observe
    environment:
      LD_LIBRARY_PATH: "$SNAP/usr/share/lemonade-server:$SNAP/usr/lib/llamacpp/vulkan:$SNAP/usr/lib/x86_64-linux-gnu:$SNAP/lib/x86_64-linux-gnu:/var/lib/snapd/lib/gl${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
      PATH: "$SNAP/usr/bin:$PATH"
  service:
    command: bin/lemonade-server-wrapper serve
    daemon: simple
    install-mode: enable
    restart-condition: on-failure
    refresh-mode: restart
    plugs:
      - home
      - removable-media
      - network
      - network-bind
      - opengl
      - process-control
      - hardware-observe
      - system-observe
    environment:
      LD_LIBRARY_PATH: "$SNAP/usr/share/lemonade-server:$SNAP/usr/lib/llamacpp/vulkan:$SNAP/usr/lib/x86_64-linux-gnu:$SNAP/lib/x86_64-linux-gnu:/var/lib/snapd/lib/gl${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
      PATH: "$SNAP/usr/bin:$PATH"
      HOME: "$SNAP_COMMON"
      LEMONADE_CACHE_DIR: "$SNAP_COMMON/cache/lemonade"

parts:
  deps:
    plugin: nil
    build-packages:
      - curl
    stage-packages:
      - libgomp1
      - libatomic1
      - libcurl4t64
      - curl # for metrics
      - hwdata # PCI ID database for lspci device name resolution
      - pciutils # lspci for GPU detection
      - unzip # For extracting backends at runtime
    override-build: |
      set +u # For unbound variables
      # workaround for build.snapcraft.io builds
      # https://bugs.launchpad.net/bugs/1886861
      if [ -n "$http_proxy" ]; then
        export ELECTRON_GET_USE_PROXY=1
        export GLOBAL_AGENT_HTTP_PROXY="${http_proxy}"
        export GLOBAL_AGENT_HTTPS_PROXY="${http_proxy}"
      fi

      craftctl default
      # Download latest PCI ID database (hwdata package version is outdated)
      mkdir -p $CRAFT_PART_INSTALL/usr/share/misc
      curl -sL https://pci-ids.ucw.cz/v2.2/pci.ids -o $CRAFT_PART_INSTALL/usr/share/misc/pci.ids

  lemonade-server:
    plugin: cmake
    source: https://github.com/lemonade-sdk/lemonade.git
    source-subdir: src/cpp
    cmake-parameters:
      - -DCMAKE_PREFIX_PATH=/usr
    build-packages:
      - build-essential
      - g++
      - cmake
      - git
      - curl
      - libcurl4-openssl-dev
      - libssl-dev
      - zlib1g-dev
      - pkg-config
    override-pull: |
      craftctl default
    override-build: |
      craftctl default
      mkdir -p $CRAFT_PART_INSTALL/usr/{bin,share}
      mv $CRAFT_PART_INSTALL/usr/local/bin/* $CRAFT_PART_INSTALL/usr/bin/
      mv $CRAFT_PART_INSTALL/usr/local/share/* $CRAFT_PART_INSTALL/usr/share/

  scripts:
    plugin: dump
    source: scripts/
    organize:
      lemonade-server-wrapper: bin/lemonade-server-wrapper
      metrics: bin/metrics
    override-prime: |
      craftctl default
      chmod +x $CRAFT_PRIME/bin/lemonade-server-wrapper
      chmod +x $CRAFT_PRIME/bin/metrics
