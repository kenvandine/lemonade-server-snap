name: Check Upstream Releases

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for upstream updates
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          SNAPCRAFT_FILE="snap/snapcraft.yaml"
          UPDATES_FOUND=false
          UPDATE_SUMMARY=""

          # Function to get latest release tag from GitHub API
          get_latest_release() {
            local repo="$1"

            # Get releases JSON
            local releases
            releases=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${repo}/releases?per_page=20")

            # Extract latest non-prerelease tag
            echo "$releases" | jq -r '[.[] | select(.prerelease == false)] | .[0].tag_name // empty'
          }

          # Function to extract version number from tag
          extract_version() {
            local tag="$1"
            # Remove common prefixes like 'v', 'b', 'release-'
            echo "$tag" | sed -E 's/^(v|b|release-)//'
          }

          echo "=== Checking lemonade-server (lemonade-sdk/lemonade) ==="
          CURRENT_LEMONADE=$(grep '^version:' "$SNAPCRAFT_FILE" | sed 's/version: *"\?\([^"]*\)"\?/\1/')
          LATEST_LEMONADE_TAG=$(get_latest_release "lemonade-sdk/lemonade")
          LATEST_LEMONADE=$(extract_version "$LATEST_LEMONADE_TAG")

          echo "Current: $CURRENT_LEMONADE"
          echo "Latest:  $LATEST_LEMONADE (tag: $LATEST_LEMONADE_TAG)"

          if [ -n "$LATEST_LEMONADE" ] && [ "$LATEST_LEMONADE" != "$CURRENT_LEMONADE" ]; then
            echo "Update available!"
            sed -i "s/^version: .*/version: \"$LATEST_LEMONADE\"/" "$SNAPCRAFT_FILE"
            UPDATES_FOUND=true
            UPDATE_SUMMARY="${UPDATE_SUMMARY}- lemonade-server: $CURRENT_LEMONADE -> $LATEST_LEMONADE\n"
          fi

          # Fetch backend versions from lemonade's backend_versions.json
          # Use the latest release tag (or current if no update)
          LEMONADE_REF="${LATEST_LEMONADE_TAG:-v$CURRENT_LEMONADE}"
          echo ""
          echo "=== Fetching backend versions from lemonade $LEMONADE_REF ==="
          BACKEND_VERSIONS_URL="https://raw.githubusercontent.com/lemonade-sdk/lemonade/${LEMONADE_REF}/src/cpp/resources/backend_versions.json"
          BACKEND_VERSIONS=$(curl -s "$BACKEND_VERSIONS_URL")

          if [ -z "$BACKEND_VERSIONS" ] || echo "$BACKEND_VERSIONS" | grep -q "404"; then
            echo "Warning: Could not fetch backend_versions.json, trying main branch"
            BACKEND_VERSIONS=$(curl -s "https://raw.githubusercontent.com/lemonade-sdk/lemonade/main/src/cpp/resources/backend_versions.json")
          fi

          echo "Backend versions JSON:"
          echo "$BACKEND_VERSIONS" | jq .

          # Extract versions from JSON
          UPSTREAM_VULKAN=$(echo "$BACKEND_VERSIONS" | jq -r '.llamacpp.vulkan')
          UPSTREAM_CPU=$(echo "$BACKEND_VERSIONS" | jq -r '.llamacpp.cpu')
          UPSTREAM_ROCM=$(echo "$BACKEND_VERSIONS" | jq -r '.llamacpp.rocm')

          echo ""
          echo "=== Checking llama.cpp Vulkan/CPU backends ==="
          # Extract current version from source URL (e.g., b7426)
          CURRENT_LLAMACPP=$(grep -oP 'ggml-org/llama\.cpp/releases/download/\Kb[0-9]+' "$SNAPCRAFT_FILE" | head -1)

          echo "Current: $CURRENT_LLAMACPP"
          echo "Upstream (vulkan): $UPSTREAM_VULKAN"
          echo "Upstream (cpu): $UPSTREAM_CPU"

          # Update Vulkan backend if different
          if [ -n "$UPSTREAM_VULKAN" ] && [ "$UPSTREAM_VULKAN" != "$CURRENT_LLAMACPP" ]; then
            echo "Vulkan backend update available!"
            # Update vulkan URL specifically
            sed -i "s|ggml-org/llama\.cpp/releases/download/b[0-9]*/llama-b[0-9]*-bin-ubuntu-vulkan|ggml-org/llama.cpp/releases/download/${UPSTREAM_VULKAN}/llama-${UPSTREAM_VULKAN}-bin-ubuntu-vulkan|g" "$SNAPCRAFT_FILE"
            UPDATES_FOUND=true
            UPDATE_SUMMARY="${UPDATE_SUMMARY}- llama.cpp vulkan: $CURRENT_LLAMACPP -> $UPSTREAM_VULKAN\n"
          fi

          # Update CPU backend if different
          CURRENT_CPU=$(grep -oP 'llama-b[0-9]+-bin-ubuntu-x64' "$SNAPCRAFT_FILE" | head -1 | grep -oP 'b[0-9]+')
          if [ -n "$UPSTREAM_CPU" ] && [ "$UPSTREAM_CPU" != "$CURRENT_CPU" ]; then
            echo "CPU backend update available!"
            # Update cpu URL specifically
            sed -i "s|ggml-org/llama\.cpp/releases/download/b[0-9]*/llama-b[0-9]*-bin-ubuntu-x64|ggml-org/llama.cpp/releases/download/${UPSTREAM_CPU}/llama-${UPSTREAM_CPU}-bin-ubuntu-x64|g" "$SNAPCRAFT_FILE"
            UPDATES_FOUND=true
            UPDATE_SUMMARY="${UPDATE_SUMMARY}- llama.cpp cpu: $CURRENT_CPU -> $UPSTREAM_CPU\n"
          fi

          echo ""
          echo "=== Checking llamacpp-rocm backend ==="
          # Extract current version from source URL (e.g., b1136)
          CURRENT_ROCM=$(grep -oP 'llamacpp-rocm/releases/download/\Kb[0-9]+' "$SNAPCRAFT_FILE" | head -1)

          echo "Current: $CURRENT_ROCM"
          echo "Upstream: $UPSTREAM_ROCM"

          if [ -n "$UPSTREAM_ROCM" ] && [ "$UPSTREAM_ROCM" != "$CURRENT_ROCM" ]; then
            echo "ROCm backend update available!"
            # Update all rocm URLs
            sed -i "s|llamacpp-rocm/releases/download/b[0-9]*/llama-b[0-9]*|llamacpp-rocm/releases/download/${UPSTREAM_ROCM}/llama-${UPSTREAM_ROCM}|g" "$SNAPCRAFT_FILE"
            UPDATES_FOUND=true
            UPDATE_SUMMARY="${UPDATE_SUMMARY}- llamacpp-rocm: $CURRENT_ROCM -> $UPSTREAM_ROCM\n"
          fi

          echo ""
          echo "=== Summary ==="
          if [ "$UPDATES_FOUND" = true ]; then
            echo "Updates found!"
            echo -e "$UPDATE_SUMMARY"
            echo "updates_found=true" >> $GITHUB_OUTPUT
            # Escape newlines for GitHub Actions
            UPDATE_SUMMARY_ESCAPED=$(echo -e "$UPDATE_SUMMARY" | sed ':a;N;$!ba;s/\n/\\n/g')
            echo "update_summary=$UPDATE_SUMMARY_ESCAPED" >> $GITHUB_OUTPUT
          else
            echo "All dependencies are up to date."
            echo "updates_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.updates_found == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update upstream dependencies"
          title: "Update upstream dependencies"
          body: |
            Automated update of upstream dependencies:

            ${{ steps.check.outputs.update_summary }}

            This PR was automatically created by the daily upstream check workflow.
          branch: update-upstream-deps
          delete-branch: true
          labels: |
            dependencies
            automated
