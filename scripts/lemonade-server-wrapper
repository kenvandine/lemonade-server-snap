#!/bin/bash
# Wrapper script to detect GPU and select appropriate backend
# Prefers ROCm for AMD GPUs, falls back to Vulkan

BACKEND="vulkan"  # default

# Check for AMD GPU using KFD sysfs interface (kernel ROCm driver)
KFD_TOPOLOGY="/sys/class/kfd/kfd/topology/nodes"

if [ -d "$KFD_TOPOLOGY" ]; then
  for node in "$KFD_TOPOLOGY"/*/; do
    if [ -f "${node}properties" ]; then
      # Check for gfx_target_version - non-zero indicates a ROCm-capable AMD GPU
      gfx_version=$(grep "^gfx_target_version " "${node}properties" 2>/dev/null | awk '{print $2}')
      if [ -n "$gfx_version" ] && [ "$gfx_version" != "0" ]; then
        BACKEND="rocm"
        echo "[Lemonade Wrapper] AMD GPU detected via KFD sysfs (gfx_target_version: $gfx_version), using ROCm backend" >&2
        break
      fi
    fi
  done
fi

if [ "$BACKEND" = "vulkan" ]; then
  echo "[Lemonade Wrapper] No ROCm-capable AMD GPU detected, using Vulkan backend" >&2
fi

exec "$SNAP/usr/local/bin/lemonade-server" "$@" --llamacpp "$BACKEND"
